package engine.managers;

import engine.utils.GameLogic;
import game.Game;
import lombok.Getter;
import org.lwjgl.glfw.GLFWErrorCallback;

import java.text.DecimalFormat;
import java.util.Objects;

import static org.lwjgl.glfw.GLFW.*;
import static org.lwjgl.opengl.GL11.*;

public class Main {
    private static final GameLogic game = new Game();
    @Getter private static boolean running = true;

    private Main() {}

    public static void main(String[] args) {
        initialize();
        run();
        cleanup();
    }

    private static void spatialRender() {
        SpatialManager.bind();
        glClearColor(0, 0, 0, 1);
        glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
        SpatialManager.setViewport();
        Scene.get().renderSpatial();
        Window.setViewport();
        SpatialManager.searchID();
        SpatialManager.unbind();
        TextureAtlas.bind();
    }

    private static void render(int clearMask, double t) {
        Window.frameUpdate();
        glClear(clearMask);

        game.update(t);
        Scene.get().update(t);
        Scene.get().render();

        InputManager.update();
        glfwPollEvents();
    }

    private static void update(double t) {
        game.staticUpdate(t);
        Scene.get().staticUpdate(t);
    }

    private static void run() {
        DecimalFormat format = new DecimalFormat(",###");
        double targetFPS = 1d / Math.max(1e-9, DataManager.getSetting("fps")); // frames per second
        double targetTPS = 1d / DataManager.getSetting("tps");                 // ticks  per second
        double targetSRR = 1d / DataManager.getSetting("spatial_fps");         // spatial refresh rate
        boolean uncappedFPS = DataManager.getFlag("uncapped_FPS");
        boolean spacialMatchFPS = DataManager.getFlag("spatial_match_fps");

        int clearMask = GL_COLOR_BUFFER_BIT;
        if (DataManager.getFlag("depth_test")) clearMask |= GL_DEPTH_BUFFER_BIT;
        else glDisable(GL_DEPTH_TEST);

        double tFPS = 0, elapsedTime;
        long start, end = System.nanoTime(), passedTime;
        double timeRender = 0, timeStatic = 0, timeSpatial = 0;
        int fpsCounter = 0, tpsCounter = 0, srrCounter = 0;

        boolean showMetrics = DataManager.getFlag("show_metrics_on_window_title");

        while (Window.shouldNotClose()) {
            // Timer Updating
            start = System.nanoTime();
            passedTime = start - end;
            end = start;
            elapsedTime = passedTime / (double) 1_000_000_000L;
            timeRender += elapsedTime;
            timeStatic += elapsedTime;
            timeSpatial += elapsedTime;
            tFPS += elapsedTime;

            // Spatial Rendering
            if (!spacialMatchFPS && timeSpatial >= targetSRR) {
                spatialRender();
                timeSpatial %= targetSRR;
                srrCounter++;
            }

            // Rendering
            if (Window.isVSync() || uncappedFPS) {
                if (spacialMatchFPS) {
                    spatialRender();
                    srrCounter++;
                }
                render(clearMask, timeRender);
                timeRender = 0;
                fpsCounter++;
            } else if (timeRender >= targetFPS) {
                if (spacialMatchFPS) {
                    spatialRender();
                    srrCounter++;
                }
                render(clearMask, timeRender);
                timeRender %= targetFPS;
                fpsCounter++;
            }

            // Static Update
            if (timeStatic >= targetTPS) {
                update(targetTPS);
                timeStatic %= targetTPS;
                tpsCounter++;
            }

            // FPS
            if (showMetrics && tFPS >= 1.) {
                tFPS %= 1.;
                Window.setTitle("FPS: %s | TPS: %s | SRR: %s".formatted(
                        format.format(fpsCounter).replaceAll(",", "."),
                        format.format(tpsCounter).replaceAll(",", "."),
                        format.format(srrCounter).replaceAll(",", ".")
                ));
                fpsCounter = tpsCounter = srrCounter = 0;
            }
        }
    }

    private static void initialize() {
        GLFWErrorCallback.createPrint(System.err).set();
        if (!glfwInit()) throw new IllegalStateException("Failed to initialize GLFW.");

        Window.initialize();
        Shader.get("shader").bind();
        SpatialManager.initialize();
        TextureAtlas.initialize();

        game.initialize();
    }

    private static void cleanup() {
        running = false;

        Window.cleanup();
        Shader.cleanup();
        Model.cleanup();
        SpatialManager.cleanup();
        TextureAtlas.cleanup();

        glfwTerminate();
        Objects.requireNonNull(glfwSetErrorCallback(null)).free();
    }
}